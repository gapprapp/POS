<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>PPS Auto Group</title>

    <!-- Bootstrap Import -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- Super cool dialog-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.js"></script>

    <!-- Easy-autocomplete -->
    <script src="js/jquery.easy-autocomplete.min.js"></script>
    <link rel="stylesheet" href="css/easy-autocomplete.min.css">
    <link rel="stylesheet" href="css/easy-autocomplete.themes.min.css">

    <script type="text/javascript" src="js/jquery.alphanumeric.js"></script>

    <!-- Sidbar -->
    <link href="css/simple-sidebar.css" rel="stylesheet">
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Prompt" rel="stylesheet">
    <!-- Main -->
    <link href="css/untitled.css" rel="stylesheet">

    <style>
        h1,h3,h4 {
            color: #4c4c4c;
        }
    
        .no-pd {
            padding-left: 0px;
            padding-right: 0px;
        }
    
        input[type="text"] {
            font-size: 20px;
        }
    </style>

    <script>
        $('#input-get').on("keyup input", function(){
            var money = $('#input-get').val();
            var net = $('#input-total').html();
            if(money - net < 0){
                $('#input-change').text("");
            }else{
                $('#input-change').text(money - net);
            }
        });

        $('#input-discount').on("keyup input", function(){
            var dis = $('#input-discount').val();
            var sum = $('#input-sum').html();          
            $('#input-total').text(sum - dis);
            $('#input-change').text(('#input-get').val() - ('#input-total').html());            
        });

        var order_id,branch_id;
        var count;
        $(document).ready(function () {
            url = new URL(window.location.href);
            order_id = url.searchParams.get("order"); 

             $.ajax({
                url:"http://150.95.26.163:8080/gitmew/php/get_order_item.php",
                method:"POST",
                data:{'order_id':order_id},
                success:function(data)
                {
                    var obj = jQuery.parseJSON(data); 
                    branch_id = obj[0].branch_id;                  
                    $('#branch').text(obj[0].branch_name); 
                    $('#date').text(obj[0].date_time); 
                    $('#number').text(obj[0].order_number); 
                    $('#user').text(obj[0].user_name);         
                    $('#cus').text(obj[0].customer_name); 
                    $('#sum').text(obj[0].sum_price);    
                    $('#discount').text(obj[0].total_discount);           
                    $('#total').text(obj[0].total_price);           
                    $('#get').text(obj[0].get_money);    
                    $('#change').text(obj[0].change_money);                      
                    $.each(obj, function(i, field){   
                        if(i > 0){
                            $('#show_prod').append("<div class='row' style='margin-bottom: 5px;'>" +
                            "<div class='col-1'></div>" +
                            "<div class='col-5 text-left' style='padding-right: 0px;'>" +
                                "<h5 id='prod-1'>"+obj[i].prod_name+"</h5>" +
                            "</div>" +
                            "<div class='col-5 text-right'>" +
                                "<h5 id='price-1' style='letter-spacing: 1px;'>"+obj[i].prod_price+" x "+obj[i].prod_amount+"</h5>" +
                            "</div>" +
                            "<div class='col-1'></div>" +
                            "</div>");

                            $('#show_edit').append("<div class='row' style='margin-bottom: 10px;'>" +
                            "<span id='span-" + i + "' hidden>" + obj[i].prod_id + "</span>"+
                            "<div class='col-1'></div>" +
                            "<div class='col-5 text-left' style='padding-right: 0px;'>" +
                                "<h5 id='input-prod'>"+obj[i].prod_name+"</h5>" +
                            "</div>" +
                            "<div class='col-2 text-right'>" +
                                "<h5 id='input-price-"+i+"'>"+obj[i].prod_price+"</h5>" +
                            "</div>" +
                            "<div class='col-1 text-right'>" +
                                "<h5>x</h5>" +
                            "</div>" +
                            "<div class='col-2 text-right'>" +
                                "<input id='input-amt-"+i+"' onchange='chng_amt("+i+","+obj[i].prod_amount+")' type='text' class='form-control text-right' value='"+obj[i].prod_amount+"'>" +
                            "</div>" +
                           " <div class='col-1'></div>" +
                            "</div>"); 
                            count = i;                  
                        }                       
                    });
                                  
                }
            });    

           
        });

        function chng_amt(arg,amt_old){
            var amt = $('#input-amt-' + arg).val();
            var prod_id = $('#span-'+arg).html();
            var price = $('#input-price-' + arg).val();
            var total_old = price*amt_old;
            var total = price*amt;
            $.ajax({
                type: "POST",
                url: "http://150.95.26.163:8080/gitmew/php/get_amt_price.php",
                data: {'prod_id' : prod_id,
                        'amount' : amt},
                success : function(data){
                    if(data != "fail"){           
                        $('#input-sum').text($('#input-sum').html()-total_old+parseInt(data));                       
                    }else{
                        $('#input-sum').text($('#input-sum').html()-total_old+parseInt(total));                      
                    }
                    $('#input-total').text($('#input-sum').html()-$('#input-discount').val());
                    $('#input-change').text($('#input-total').html()-$('#input-get').val());
                }
            });
        }

        function edit(){
            $("#ctn-show").prop('hidden', true);
            $("#ctn-edit").prop('hidden', false);

            //Copy val to input-val
            $('#input-branch').text($('#branch').html()); 
            $('#input-date').text($('#date').html()); 
            $('#input-number').text($('#number').html()); 
            $('#input-user').text($('#user').html());         
            $('#input-cus').text($('#cus').html()); 
            $('#input-sum').text($('#sum').html());    
            $('#input-discount').val($('#discount').html());           
            $('#input-total').text($('#total').html());           
            $('#input-get').val($('#get').html());    
            $('#input-change').text($('#change').html());                        
        }

        function save(){
            json = [];
            for(var j = 1 ; j <= count ; j++){
                item = {}
                item ["item_id"] =  j;
                item ["amt"] = $('#input-amt-' + j).val();  
                item ["prod_id"] = $('#span-'+j).html();           
                json.push(item);
            }
            var jsonString = JSON.stringify(json);
            var datastr = {'JSON': jsonString, 
            'sum': $('input-sum').html(), 
            'discount': $('input-discount').val(), 
            'total': $('input-total').html(), 
            'get': $('input-get').val(), 
            'change': $('input-change').html(),
            'order_id':order_id,
            'branch_id':branch_id};

            $.ajax({
                url: "http://150.95.26.163:8080/gitmew/php/update_order_item.php",
                type: "POST",
                data: datastr,
                success: function (data) {

                }
            });
            $("#ctn-show").prop('hidden', false);
            $("#ctn-edit").prop('hidden', true);
        }

        function remove() {
            $.confirm({
                icon: 'fa fa-warning',
                title: 'แน่ใจหรือว่าต้องการลบ!',
                content: 'ต้องการลบรายการขายสินค้า!',
                buttons: {
                    danger: {
                        btnClass: 'btn-danger',
                        text: 'ลบ',
                        action: function () {                                                    
                            $.ajax({
                                url: "http://150.95.26.163:8080/gitmew/php/delete_order.php",
                                type: "POST",
                                data: {
                                    'order_id': order_id
                                },
                                success: function (data) {
                                    if (data == "success") {
                                        $.alert({
                                            icon: 'fa fa-warning',
                                            title: 'เตือน',
                                            content: 'รายการสินค้าได้ถูกลบแล้ว',
                                        }); 
                                        window.location = "manage_bill.html";                                       
                                    } else {
                                        $.alert({
                                            icon: 'fa fa-warning',
                                            title: 'เตือน',
                                            content: 'โปรดลองอีกครั้ง',
                                        });
                                    }
                                }
                            });
                        }
                    },
                    ยกเลิก: function () { },
                }
            });
        }
    </script>
</head>

<body>
    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav" style="margin-top: 20px">
                <li class="sidebar-brand">
                    <a id="sidebar-title" href="http://150.95.26.163:8080/gitmew/sale.html">PPS Auto Group</a>
                </li>
                <li>
                    <a href="http://150.95.26.163:8080/gitmew/import.html">๐ สินค้าเข้า</a>
                </li>
                <li>
                    <a href="http://150.95.26.163:8080/gitmew/manage_prod.html">๐ จัดการสินค้า</a>
                </li>
                <li>
                    <a href="http://150.95.26.163:8080/gitmew/manage_cus.html">๐ จัดการลูกค้า</a>
                </li>
                <li>
                    <a href="http://150.95.26.163:8080/gitmew/sale.html">๐ ทำรายการขาย</a>
                </li>
                <li>
                    <a href="#" onclick="logout()">๐ ออกจากระบบ ๐</a>
                </li>
            </ul>
        </div>
        <!-- End sidebar -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-md navbar-dark mb-4 rounded" style="background: #a4e3b3;">
                <div class="clearfix">
                    <a href="#menu-toggle" class="navbar-brand " id="menu-toggle">รายการ</a>
                </div>
                <div class="collapse navbar-collapse justify-content-md-center" id="navbarCollapse">
                    <h3 id="nav-title">รายละเอียดรายการ</h3>
                </div>
            </nav>
            <!-- End Navbar -->

            <div id="ctn-show" class="container justify-content-center" style="width: 50%">
                <div class="jumbotron text-center" style="background: #fdfcfb; padding: 20px; ">
                    <div class="row">
                        <div class="col-7 text-right">
                            <h5>PPS AUTO GROUP</h5>
                        </div>
                        <div class="col-4 text-left no-pd">
                            <h5 id="branch"></h5>
                        </div>
                    </div>
                    <h5 id="number" style="margin-top: 15px;"></h5>
                    <h5 id='date' style="letter-spacing: 2px;"></h5>
                    <div class="row" style="margin-bottom: 5px;">
                        <div class="col-1"></div>
                        <div class="col-2 text-left">
                            <h5>ผู้บันทึก : </h5>
                        </div>
                        <div class="col-2 text-left no-pd">
                            <h5 id='user'></h5>
                        </div>
                        <div class="col-2 text-right">
                            <h5>ลูกค้า : </h5>
                        </div>
                        <div class="col-5 text-left no-pd">
                            <h5 id='cus'></h5>
                        </div>            

                    </div> 
                    <hr style="width: 80%">
                    
                    <div id="show_prod">
                        
                    </div>                 
                    <hr style="width: 80%">

                    <div class="row" style="margin-bottom: 5px;">
                        <div class="col-3"></div>
                        <div class="col-4 text-left" style="padding-right: 0px;">
                            <h5>รวม</h5>
                        </div>
                        <div class="col-2 text-right">
                            <h5 id='sum' style="letter-spacing: 1px;"></h5>
                        </div>
                    </div>
                    <div class="row" style="margin-bottom: 5px;">
                        <div class="col-3"></div>
                        <div class="col-4 text-left" style="padding-right: 0px;">
                            <h5>ลด</h5>
                        </div>
                        <div class="col-2 text-right">
                            <h5 id='discount' style="letter-spacing: 1px;"></h5>
                        </div>
                    </div>
                    <div class="row" style="margin-bottom: 5px;">
                        <div class="col-3"></div>
                        <div class="col-4 text-left" style="padding-right: 0px;">
                            <h5>สุทธิ</h5>
                        </div>
                        <div class="col-2 text-right">
                            <h5 id='total' style="letter-spacing: 1px;"></h5>
                        </div>
                    </div>
                    <div class="row" style="margin-bottom: 5px;">
                        <div class="col-3"></div>
                        <div class="col-4 text-left" style="padding-right: 0px;">
                            <h5>รับ</h5>
                        </div>
                        <div class="col-2 text-right">
                            <h5 id='get' style="letter-spacing: 1px;"></h5>
                        </div>
                    </div>
                    <div class="row" style="margin-bottom: 35px;">
                        <div class="col-3"></div>
                        <div class="col-4 text-left" style="padding-right: 0px;">
                            <h5>ทอน</h5>
                        </div>
                        <div class="col-2 text-right">
                            <h5 id='change' style="letter-spacing: 1px;"></h5>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 text-center">
                            <button class="btn btn-lg btn-primary" style="width: 20%;" onclick="edit();">
                                แก้ไข <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-lg btn-danger" style="width: 20%;" onclick="remove();">
                                ลบ
                                <i class="fa fa-close"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="ctn-edit" class="container justify-content-center" style="width: 50%" hidden>
                <div class="jumbotron text-center" style="background: #fdfcfb; padding: 20px; ">
                    <div class="row">
                        <div class="col-7 text-right">
                            <h5 style="margin-top: 2%;">PPS AUTO GROUP</h5>
                        </div>
                        <div class="col-3 text-left">
                            <h5 id="input-branch"></h5>
                        </div>
                    </div>
                    
                    <h5  id="input-number" style="margin-top: 15px;">S18-00018</h5>
                    <h5 id='input-date' style="letter-spacing: 2px;"></h5>
                    <div class="row" style="margin-bottom: 5px;">
                        <div class="col-1"></div>
                        <div class="col-2 text-left">
                            <h5 style="margin-top: 5%;">ผู้บันทึก : </h5>
                        </div>
                        <div class="col-2 text-left no-pd">
                            <h5 id="input-user"></h5>
                        </div>
                        <div class="col-2 text-right">
                            <h5 style="margin-top: 5%;">ลูกค้า : </h5>
                        </div>
                        <div class="col-5 text-left no-pd">
                            <h5 id="input-cus"></h5>
                        </div>
                    </div>
                    <hr style="width: 80%">
            
                    <div id="show_edit">                       
                        
                    </div>
                   
                    <hr style="width: 80%">
            
                    <div class="row" style="margin-bottom: 10px;">
                        <div class="col-3"></div>
                        <div class="col-4 text-left" style="padding-right: 0px;">
                            <h5>รวม</h5>
                        </div>
                        <div class="col-3 text-right no-pd">
                            <h5 id="input-sum"></h5>
                        </div>
                    </div>
                    <div class="row" style="margin-bottom: 5px;">
                        <div class="col-3"></div>
                        <div class="col-4 text-left" style="padding-right: 0px;">
                            <h5>ลด</h5>
                        </div>
                        <div class="col-3 text-right no-pd">
                            <input id="input-discount" type="text" class="form-control text-right" value="9000">
                        </div>
                    </div>
                    <div class="row" style="margin-bottom: 5px;">
                        <div class="col-3"></div>
                        <div class="col-4 text-left" style="padding-right: 0px;">
                            <h5>สุทธิ</h5>
                        </div>
                        <div class="col-3 text-right no-pd">
                            <h5 id="input-total"></h5>
                        </div>
                    </div>
                    <div class="row" style="margin-bottom: 5px;">
                        <div class="col-3"></div>
                        <div class="col-4 text-left" style="padding-right: 0px;">
                            <h5>รับ</h5>
                        </div>
                        <div class="col-3 text-right no-pd">
                            <input id="input-get" type="text" class="form-control text-right" value="5000">
                        </div>
                    </div>
                    <div class="row" style="margin-bottom: 35px;">
                        <div class="col-3"></div>
                        <div class="col-4 text-left" style="padding-right: 0px;">
                            <h5>ทอน</h5>
                        </div>
                        <div class="col-3 text-right no-pd">
                            <h5 id="input-change"></h5>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 text-center">
                            <button class="btn btn-lg btn-success" style="width: 20%;" onclick="save();">
                                บันทึก
                                <i class="fa fa-check-square"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End page content wrapper -->
    </div>
    <!-- End Wrapper -->

    <!-- Menu Toggle -->
    <script>
        // Menu Toggle
        $("#menu-toggle").click(function (e) {
            e.preventDefault();
            $("#wrapper").toggleClass("toggled");

            if ($("#menu-toggle").text() == "รายการ") {
                $("#menu-toggle").text("กลับ");
            } else if ($("#menu-toggle").text() == "กลับ") {
                $("#menu-toggle").text("รายการ");
            }
        });
    </script>
</body>

</html>